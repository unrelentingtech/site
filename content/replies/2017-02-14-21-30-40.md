+++
date = 2017-02-14T21:30:40+00:00
path = "/replies/2017-02-14-21-30-40"

[extra]
client_id = ["https://micropublish.net"]

[[extra.in_reply_to]]
author = "https://seblog.nl"
bookmark = "https://aaronparecki.com/2017/02/13/11/"
name = "How I hacked my own site by feeding it a profile picture via webmention"
published = 2017-02-13T22:12:50+00:00
type = "entry"
updated = 2017-02-13T22:12:50+00:00
url = "https://seblog.nl/2017/02/13/3/how-i-hacked-my-own-site"

[extra.in_reply_to.content]
text = "Two weeks ago I wrote that I hacked my own site. I think it’s important to share how I did it, to make people more aware of possible vulnerabilities, so they can find them too. If others didn’t write about their findings, I wouldn’t have found this one.\nI did my best to reach out to people using the same code. If you are using the Kirby Webmentions plugin or my fork of it, please make sure to update!\nWebmentions\nAs some of you may know, my site supports webmentions. In short, this enables me to show replies underneath my posts, that are written by people on their own site. If you write a reply, link to me, mark it up with Microformats and send a webmention, my site fetches your post and shows it as a reply. I use a service called Bridgy to also receive comments from Twitter and Instagram. All of this is automated and very cool.\nHowever, while very cool, it is also potentially dangerous to show external content on your site. The vulnerability I found is an example of what can go wrong.\nIf you look around on my site, you see I do not only show the content of the reply, but also a picture of the author, if provided. This is especially nice when showing likes:\n\nThis nice overview of likes comes from the Kirby Webmentions plugin by Bastian Allgeier, which I modified a bit.\nMy server takes the fall\nIn order to protect visitors of my site from other security issues, the plugin downloads the images and shows those downloaded ones. This way my visitors only deal with my server, and not with the servers of everyone who liked my post. It’s a nice service, but it also means that I move the problem: I now have to handle those images with care on my side. My server takes the fall for my visitors.\nThe problem is: my server just downloads whatever image you give it. In most cases, this will be a nice avatar I can display for my friendly visitors. But one can think of a case where a not-so-friendly visitor feeds my site something else than an image. The plugin of course checks if it’s an image and rejects files that are not a image, but it’s still worth a try.\nSo, what did you feed it?\nSince my server runs on PHP, the nicest thing for an attacker to feed my server is a PHP-file. That way, you can run whatever code you want on my server, doing all kinds of evil things. However, just straight off feeding my site a PHP-file did not work. The plugin is not crazy. It checked wether the MIME of the file was an image of type jpeg, png or gif. It rejected an image.php file like this:\necho \"hi!\";\nUsing image.jpg as filename would fail too: the plugin saw that the file had no MIME of an image, so it did not download it. This was the point where I went to bed with a feeling of security: my site was safe and I could not get a php-script in.\nThe next day, however, I had second thoughts. I needed a real image for my new plan, so I took a screenshot of a smiley. I then opened it in notepad and added the following to the bottom of the file:\n&lt;?php mail(‘my.email@gmail.com’, ‘Seb’, ‘hi’);\nI then renamed the file to image.php, because you need the PHP-extension in your file to let the server run your code. The last step was disabling PHP on my test-server, to prevent the test-server from executing the code and send mail me. The code just appeared at the end of the image.\nI then made a test-post with a u-like-of set to the URL of a post on my blog, and a p-author h-card with an &lt;img src=\"/photo.php\"&gt;. It was a like, with an author and an my bad image.\nAnd it worked.\nThe server sees the image and checks for the MIME, which was image/jpeg, because it was an image. It then downloaded it, including the un-executed PHP string in the bottom of it. It changed the name of the image into the SHA1-hash of the original image-url, but then it appended the extension of the original file, which was .php!\nMy server then had a file called a266d629bb26d74752080bb1b95bbd0a488bea53.php, which was linked as an image in my post. Every time I refreshed the page, the snippet of code in the bottom of the file got executed, so it sent an e-mail to me.\n\nIn this example, I sent an e-mail, but it could’ve been anything.\nHow to solve?\nFirst off: check your input! And then check it again. A crucial thing for PHP-files is that they get executed if they have the .php extension, so you should not rely on user input for that. Change the filename and change the extension.\nBastian updated the plugin, so now it does not only check for MIME, but also only accepts files with the extensions jpg, jpeg, png and gif. Only if it has a correct extension, it downloads the file, and it checks MIME twice, both before and after the download. I think it’s locked down pretty well, although it still feels a bit scary.\nAaron Parecki, who did this way of showing likes first, uses an external service for his webmention images, and that’s not a bad idea either. If someone manages to get in something bad, it’s not on your the same server as your site. It could also be a good idea to turn off PHP for your upload folder, if you have that kind of access to your server.\nFinal words\nI really like this webmention plugin! It’s thanks to this plugin that I know IndieWeb and all the wonderful things it brings.\nBut while the plugin and IndieWeb are nice, it’s also good to keep and eye on security. At this moment, webmention is relatively safe because not many people know about it or use it. Although it can be a lot of fun to have a post of a friend automatically show up beneath your post, we have to be aware of the risks of showing content of external parties.\nSo, be warned, and have fun."

+++

<p>Yeah, this is the one of the big problems with PHP, and Apache mod_php specifically. You can implement various mitigations (drop an <code>.htaccess</code> into the uploads directory that turns off any script execution?) but the fact that you <em>have to</em> is kinda ridiculous. Pretty much <em>all</em> other web development environments are not based around just running scripts from the same directories where static files are. Heck, Apache’s CGI implementation was better, it only ran code from the <code>/cgi-bin/</code> subdirectory!</p>