+++
date = 2017-05-04T21:02:35+00:00
path = "/likes/2017-05-04-21-02-35"

[extra]
client_id = ["https://micropublish.net"]

[[extra.like_of]]
author = "https://colinwalker.blog/"
name = "Sending likes and replies using custom fields"
published = 2017-04-25T11:20:46+00:00
type = "entry"
url = "https://colinwalker.blog/2017/04/25/sending-likes-and-replies-using-custom-fields/"

[extra.like_of.content]
text = "Historically, we would visit someone else’s site to leave a comment or click a like button. Sometimes these interactions would be held within their own site’s data but, frequently, they would be stored remotely – think Facebook Likes or Disqus comments.\nIn keeping with owning your content, part of the#indieweb ethos is to perform these actions on your own site but pass them back so they show in both locations. The original, however, is held by yourself.\nThe Post Kinds plugin for WordPress is designed to add support for “responding to and interacting with other sites” by implementing “kinds of posts” – specific post types with a particular purpose. So I thought I’d give it a try.\nThe plugin didn’t work in the way I’d imagined, however, and caused issues with my theme due to the way it maps its own post types to those already in WordPress.\u2028\nWhile new templates can be designed for how it integrates, all I really wanted it for was likes and replies so the effort required to get everything back as if should be seemed a bit counter-productive.\nBack to the drawing board.\nA different way\nOnce webmentions are enabled the actual markup required to turn a link to another page into a like or reply is actually pretty simple – specific classes are added to identify their purpose:\nReply = class=\"u-in-reply-to\"\nLike = class=\"u-like-of\"\nThis would be easy enough to add to the post HTML but, as I avoid the WordPress back end as much as possible, I wanted an easier way.\nWhat if I could automatically add this without a plugin?\nAs I post from my phone I starting thinking how I could pass a URL to WordPress along with the post; I was instantly reminded of the trick I used to tell it about the path to microcast episodes:\nCustom fields.\nA like is usually a short post so perfect for Drafts and Workflow – custom fields can be populated directly from the ‘Post to WordPress’ action.\nReplies are more likely to be longer posts but Ulysses doesn’t, natively, allow for the same behaviour. I would just have to add the custom field after posting as a draft.\nNow that the link data could be included with the post how could it be added with the relevant markup to trigger webmentions?\nFunctions\nI had already used code in functions.php to alter posts (the creation of hashtag links, for example) but this was purely a run-time change altering how the content was displayed, not stored:\nadd_filter( 'the_content', 'linked_hashtags' );\nTo trigger webmentions the links need to be included in the actual body of the post so modifying the_content wouldn’t work. Luckily, WordPress includes a way to do this in content_save_pre which lets you modify a post’s content before being saved to the database.\nIn order to build the webmention links I needed to get the page title as well as the link. The function file_get_contents() reads the contents of a file (in this case a web page) into a string and I used an example found on the web to extract the page title from that:\n$str = file\\_get\\_contents($replyurl);\n$str = trim(preg_replace('/\\s+/', ' ', $str));\npreg_match(\"/\\&lt;title\\&gt;(.*)\\&lt;\\/title\\&gt;/i\",$str,$replytitle);\nPutting it together\nWith all the pieces in place, all that remained was to put everything together running a function to build the links when saving the post:\nadd_filter( 'content_save_pre', 'mentiontypes' );\nPulling the URL from the custom field is done using get_post_meta() specifying the post ID and field name. The required string is built and added to the front of the post content before being returned back to the post as the new body.\nBecause content_save_pre runs whenever a post is saved editing would cause the link to be re-added on each occasion. To prevent this I opted to delete the custom field using delete_post_meta() after the link is first inserted to avoid duplication.\nThe full code is included below. Let me know if you can think of any improvements.\nUpdate: Jeremy Cherfas pointed out that some consider file_get_contents() to be insecure so advised using wp_remote_get() instead. The code below has been updated to reflect this change.\nfunction mentiontypes ( $content ) {\n\n  $id = get_the_ID();\n  $types = array ( 'Reply', 'Liked' );\n\n  foreach ( $types as $type) {\n    $mentionurl = (get_post_meta($id, $type, true));\n\n    if ( $mentionurl !=\"\" ) {\n      $url = wp_remote_get($mentionurl);\n      $str = wp_remote_retrieve_body($url);\n      $str = trim(preg_replace('/\\s+/', ' ', $str));\n      preg_match(\"/\\&lt;title\\&gt;(.*)\\&lt;\\/title\\&gt;/i\",$str,$mentontitle);\n\n      if ( $type == 'Reply' ) {\n        $mentionstr = '&lt;p&gt;&lt;em&gt;In reply to: &lt;a class=\"u-in-reply-to\" href=\"' . $mentionurl . '\"&gt;' . $mentiontitle[1] . '&lt;/a&gt;...&lt;/em&gt;&lt;/p&gt;';\n      } else {\n        $mentionstr = '&lt;p&gt;&lt;em&gt;Liked: &lt;a class=\"u-like-of\" href=\"' . $mentionurl . '\"&gt;' . $mentiontitle[1] . '&lt;/a&gt;...&lt;/em&gt;&lt;/p&gt;';\n      }\n\n      $content = $mentionstr . $content;\n      delete_post_meta( $id, $type, $mentionurl );\n    }\n  }\n\n  return $content;  \n}\n\nadd_filter( 'content_save_pre', 'mentiontypes' );\nReply on Medium, or with a webmention.Share this:TwitterFacebook\t\t\t\t→ April 25th, 2017"

+++

