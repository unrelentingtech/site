+++
date = 2017-07-09T12:38:57+00:00
path = "/likes/2017-07-09-12-38-57"

[extra]
client_id = ["https://micropublish.net"]

[[extra.like_of]]
author = "https://aaronparecki.com/"
name = "Creating a Self-Hosted Alternative to Facebook Live using Nginx and Micropub"
published = 2016-11-19T23:19:57+00:00
type = "entry"
url = "https://aaronparecki.com/2016/11/19/15/self-hosted-facebook-live"

[extra.like_of.content]
text = "Facebook Live offers a seamless viewing experience for people to watch your livestream and then see an archived version after you're done broadcasting.\n\nWhen you turn on your camera, a new Facebook post is created on your profile and indicates that you're broadcasting live.\nWhen you stop broadcasting, Facebook automatically converts the video to an archived version and shows people the recording when they look at that post later.\n\nI wanted to see if I could do this on my own website, without any third-party services involved. It turns out there is free software available to put this kind of thing together yourself!\n\nThe diagram below illustrates the various pieces involved. In this post, we'll walk through setting up each. In this setup, the streaming server is separate from your website. You can of course host both on the same server, but I found it was nicer to fiddle with the nginx settings on a separate server rather than recompiling and restarting nginx on my website's server.\n\n\n\nVideo Source\n\nYou should be able to use any RTMP client to stream video to the server! I've tested this setup with the following video sources:\n\nTeradek Vidiu hardware encoder (connected to an HDMI switcher or camcorder)\nOn my Mac, I've used OBS, a cross-platform desktop application\nOn iOS, Larix Broadcaster (also available on Android)\n\nThe job of the video source is to perform the h.264 encoding and send the video stream to the RTMP endpoint on the streaming server. Once configured, starting the broadcast is as simple as starting the streaming device.\n\nBuilding the Streaming Server\n\nNginx with RTMP extension\n\nThe instructions below are a summary of this excellent guide.\n\nDownload build system dependencies\nDownload nginx source code\nDownload RTMP extension source code\nCompile nginx with the extension\n\nDownload the build system dependencies\n\nsudo apt-get install build-essential libpcre3 libpcre3-dev libssl-dev\n\nFind the latest nginx source code at http://nginx.org/en/download.html\n\nwget http://nginx.org/download/nginx-1.10.2.tar.gz\n\nDownload the rtmp module source\n\nwget https://github.com/arut/nginx-rtmp-module/archive/master.zip\n\nUnpack both and enter the nginx folder\n\ntar -zxvf nginx-1.10.2.tar.gz\nunzip master.zip\ncd nginx-1.10.2\n\nBuild nginx with the rtmp module\n\n./configure --with-http_ssl_module --add-module=../nginx-rtmp-module-master\nmake -j 4\nsudo make install\n\nNow you can start nginx!\n\nsudo /usr/local/nginx/sbin/nginx\n\nConfiguration\n\nThe steps below will walk through the following. Comments are inline in the config files.\n\nSet up the nginx configuration to accept RTMP input and output an HLS stream\nConfigure the event hooks to run the bash commands that will make Micropub requests and convert the final video to mp4\nSet up the location blocks to make the recordings available via http\nEnsure the folder locations we're using are writable by nginx\n\nFirst, add the following server block inside the main http block.\n\nserver {\n  server_name stream.example.com;\n\n  # Define the web root where we'll put the player HTML/JS files\n  root /web/stream.example.com/public;\n\n  # Define the location for the HLS files\n  location /hls {\n    types {\n      application/vnd.apple.mpegurl m3u8;\n    }\n\n    root /web/stream.example.com; # Will look for files in the /hls subdirectory\n\n    add_header Cache-Control no-cache;\n\n    # Allow cross-domain embedding of the files\n    add_header Access-Control-Allow-Origin *;    \n  }\n}\n\nOutside the main http block, add the following to set up the rtmp endpoint.\n\nrtmp {\n  # Enable HLS streaming\n  hls on;\n  # Define where the HLS files will be written. Viewers will be fetching these\n  # files from the browser, so the `location /hls` above points to this folder as well\n  hls_path /web/stream.example.com/hls;\n  hls_fragment 5s;\n\n  # Enable recording archived files of each stream\n  record all;\n  # This does not need to be publicly accessible since we'll convert and publish the files later\n  record_path /web/stream.example.com/rec;\n  record_suffix _%Y-%m-%d_%H-%M-%S.flv;\n  record_lock on;\n\n  # Define the two scripts that will run when recording starts and when it finishes\n  exec_publish /web/stream.example.com/publish.sh;\n  exec_record_done /web/stream.example.com/finished.sh $path $basename.mp4;\n\n  access_log logs/rtmp_access.log combined;\n  access_log on;\n\n  server {\n    listen 1935;\n    chunk_size 4096;\n\n    application rtmp {\n      live on;\n      record all;\n    }\n  }\n}\n\nStarting Streaming\n\nWhen a stream starts, the nginx extension will run the script defined by the exec_publish hook. We'll set up this script to create a new post on your website via Micropub. This post will contain the text \"Streaming Live\" and will include HTML with an iframe containing the &lt;video&gt; tag and the necessary Javascript to enable the video player.\n\nThe nginx extension takes care of building the HLS files that the player uses, and will broadcast the input stream to any client that connects.\n\nYour server will need to support Micropub for this command to work. Micropub is a relatively simple protocol for creating and updating posts on your website. You can find Micropub plugins for various software, or write your own code to handle the request. For the purposes of this example, you will need to manually generate an access token and paste it into the scripts below.\n\nSave the following as publish.sh\n\n#!/bin/bash\n\nfile_root=\"/web/stream.example.com/rec\"\nweb_root=\"http://stream.example.com\"\n\nmicropub_endpoint=https://you.example.com/micropub\naccess_token=123123123\n\n# Create the post via Micropub and save the URL\nurl=`curl -i $micropub_endpoint -H \"Authorization: Bearer $access_token\" \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\"type\":\"h-entry\",\"properties\":{\"content\":{\"html\":\"&lt;p&gt;Streaming Live&lt;/p&gt;&lt;iframe width=\\\"600\\\" height=\\\"340\\\" src=\\\"http://stream.example.com/live.html\\\"&gt;&lt;/iframe&gt;\"}}}' \\\n  | grep Location: | sed -En 's/^Location: (.+)/\\1/p' | tr -d '\\r\\n'`\n\n# Write the URL to a file\necho $url &gt; $file_root/last-url.txt\n\nWhen the Broadcast is Complete\n\nWhen the source stops broadcasting, the nginx extension will run the script defined by the exec_record_done hook. This script will eventually update the post with the final mp4 video file so that it appears archived on your website.\n\nUpdate the post to remove the iframe and replace it with a message saying the stream is over and the video is being converted\nDo the conversion to mp4 (this may take a while depending on the length of the video)\nCreate a jpg thumbnail of the video\nUpdate the post, removing the placeholder content and replacing it with the thumbnail and final mp4 file\n\nSave the following as finished.sh\n\n#!/bin/bash\n\ninput_file=$1\nvideo_filename=$2\n# Define the location that the publicly accessible mp4 files will be served from\noutput=/web/stream.example.com/public/archive/$2;\n\nfile_root=\"/web/stream.example.com/rec\"\nweb_root=\"http://stream.example.com\"\n\nmicropub_endpoint=https://you.example.com/micropub\naccess_token=123123123\n\n# Find the URL of the last post created\nurl=`cat $file_root/last-url.txt`\n\n# Replace the post with a message saying the stream has ended\ncurl $micropub_endpoint -H \"Authorization: Bearer $access_token\" \\\n  -H \"Content-Type: application/json\" \\\n  -d \"{\\\"action\\\":\\\"update\\\",\\\"url\\\":\\\"$url\\\",\\\"replace\\\":{\\\"content\\\":\\\"&lt;p&gt;The live stream has ended. The archived version will be available here shortly.&lt;/p&gt;\\\"}}\"\n\n# Convert the recorded stream to mp4 format, making it available via HTTP\n/usr/bin/ffmpeg -y -i $input_file -acodec libmp3lame -ar 44100 -ac 1 -vcodec libx264 $output;\nvideo_url=\"$web_root/archive/$video_filename\"\n\n# Generate a thumbnail and send it as the photo\nffmpeg -i $output -vf \"thumbnail,scale=1920:1080\" -frames:v 1 $output.jpg\nphoto_url=\"$web_root/archive/$video_filename.jpg\"\n\n# Replace the post with the video and thumbnail (Micropub update)\ncurl $micropub_endpoint -H \"Authorization: Bearer $access_token\" \\\n  -H \"Content-Type: application/json\" \\\n  -d \"{\\\"action\\\":\\\"update\\\",\\\"url\\\":\\\"$url\\\",\\\"replace\\\":{\\\"content\\\":\\\"&lt;p&gt;The live stream has ended. The archived video can now be seen below.&lt;/p&gt;\\\"},\\\"add\\\":{\\\"video\\\":\\\"$video_url\\\",\\\"photo\\\":\\\"$photo_url\\\"}}\"\n\nNote that your Micropub endpoint must support JSON updates, as well as recognizing the photo and video properties as URLs rather than file uploads. The filenames sent will be unique, so it's okay for your website to link directly to the URLs provided, but your endpoint may also want to download the video and serve it locally instead.\n\nWeb Player\n\nWe'll host the HLS video player on the streaming server, so that you don't have to worry about uploading this javascript to your website. We'll use video.js with the HLS plugin.\n\nCreate a file live.html in the web root and copy the following HTML.\n\n&lt;!DOCTYPE html&gt;\n&lt;html&gt;\n&lt;head&gt;\n  &lt;link href=\"https://vjs.zencdn.net/5.8.8/video-js.css\" rel=\"stylesheet\"&gt;\n  &lt;style type=\"text/css\"&gt;\n    body {\n      margin: 0;\n      padding: 0;\n    }\n  &lt;/style&gt;\n&lt;/head&gt;\n&lt;body&gt;\n  &lt;video id=\"video-player\" width=\"600\" height=\"340\" class=\"video-js vjs-default-skin\" controls&gt;\n    &lt;source src=\"http://stream.example.com/hls/live.m3u8\" type=\"application/x-mpegURL\"&gt;\n  &lt;/video&gt;\n\n  &lt;script src=\"https://vjs.zencdn.net/5.8.8/video.js\"&gt;&lt;/script&gt;\n  &lt;script src=\"https://cdnjs.cloudflare.com/ajax/libs/videojs-contrib-hls/3.6.12/videojs-contrib-hls.js\"&gt;&lt;/script&gt;\n  &lt;script&gt;\n  var player = videojs('video-player');\n  player.play();\n  &lt;/script&gt;\n&lt;/body&gt;\n&lt;/html&gt;\n\nNow when you view live.html in your browser, it will load the streaming player and let you start playing the stream! This is the file that we'll be using in an iframe in posts on your website.\n\nSetting up your Website\n\nAs previously mentioned, the scripts above use Micropub to create and update posts. If your website is a fully conformant Micropub endpoint, you shouldn't need to do anything special for this to work!\n\nYou will need to make sure that your website allows Micropub clients to create posts with HTML content. You will also need to ensure your endpoint supports the photo and video properties supplied as a URL. You can hotlink the URLs your endpoint receives instead of downloading the files if you want, or your endpoint can download a copy of the video and serve it locally.\n\nRealtime Updates\n\nTo really make this shine, there are a few things you can do to enable realtime updates of your posts for viewers.\n\nWhen your Micropub endpoint creates or updates a post, broadcast the HTML of the post on an nginx push-stream channel, and use Javascript on your home page to insert the post at the top of your feed.\nUse WebSub (formerly known as PubSubHubbub) to publish updates of your home page to subscribers who may be reading your website from a reader.\n\nDoing this will mean someone who has your home page open in a browser will see the new livestream appear at the top as soon as you start broadcasting, and they'll be able to see it change to the archived video when you're done. People following you in a reader will see the new post with the streaming player when the reader receives the WebSub notification!\n\nPublish Once, Syndicate Elsewhere\n\nSince the nginx RTMP extension supports rebroadcasting the feed to other services, you can even configure it to also broadcast to Facebook Live or YouTube!\n\nYou'll need to find the RTMP endpoint for your Facebook or YouTube Live account, and configure a new block in your nginx settings.\n\nDoing this means you can use Facebook and YouTube as additional syndications of your live stream to increase your exposure, or treat them as an automatic backup of your videos!"

+++

